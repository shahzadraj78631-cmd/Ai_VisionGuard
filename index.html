<script>
window.addEventListener("load", function() {

  // ===== Supabase Init =====
  const supabaseUrl = "https://gwlvjpykmjxltiarrvyv.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3bHZqcHlrbWp4bHRpYXJydnl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MTQ2NTEsImV4cCI6MjA3NjE5MDY1MX0.0awguN5ZMtDY4J-aQJOo1sfwE04cql0QMPRWmLe9jiI";
  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

  // ===== DOM Elements =====
  const home = document.getElementById("homeSection");
  const login = document.getElementById("loginSection");
  const alerts = document.getElementById("alertsSection");
  const homeBtn = document.getElementById("homeBtn");
  const alertsBtn = document.getElementById("alertsBtn");
  const loginBtn = document.getElementById("loginBtn");
  const loginEmail = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");
  const loginMsg = document.getElementById("loginMsg");
  const allowBtn = document.getElementById("allowNotif");

  // ===== Initial View =====
  home.style.display = "block";
  login.style.display = "none";
  alerts.style.display = "none";

  // ===== OneSignal Setup =====
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "34f002f6-4328-4ab5-bcb2-e24a4f210971",
      notifyButton: { enable: false },
      promptOptions: { slidedown: { enabled: false } }
    });

    console.log("✅ OneSignal initialized");

    // Enable button once ready
    allowBtn.disabled = false;
    allowBtn.textContent = "Allow Notifications 🔔";

    // Button click handler — actual prompt trigger
    allowBtn.addEventListener("click", async () => {
      try {
        const status = await OneSignal.getNotificationPermission();
        console.log("Permission status:", status);

        if (status === "granted") {
          alert("✅ Notifications already allowed!");
        } else {
          // Must call this directly on click (browser rule)
          await OneSignal.registerForPushNotifications({
            modalPrompt: true
          });
          alert("✅ Notifications enabled successfully!");
        }
      } catch (e) {
        console.error("❌ OneSignal error:", e);
        alert("❌ Failed to enable notifications. Check browser permission settings.");
      }
    });

    // Auto prompt after small delay if not allowed
    setTimeout(async () => {
      const status = await OneSignal.getNotificationPermission();
      if (status === "default") {
        console.log("Auto prompting for permission...");
        OneSignal.showNativePrompt(); // more reliable for Chrome/Edge
      }
    }, 3000);
  });

  // ===== Load Alerts =====
  async function loadAlerts() {
    const div = document.getElementById("alertList");
    try {
      const { data, error } = await supabaseClient.from("alerts").select("*").order("id", { ascending: false });
      if (error) { div.innerHTML = "Error loading alerts"; return; }
      if (!data || !data.length) { div.innerHTML = "No alerts recorded yet."; return; }
      div.innerHTML = "";
      data.forEach((a) => {
        const c = document.createElement("div");
        c.className = "alert-card row";
        c.innerHTML = `
          <img class="thumb" src="${a.snapshot_url}" alt="snapshot"/>
          <div>
            <b>Type:</b> ${a.type}<br/>
            <b>Person:</b> ${a.person}<br/>
            <a class="contrast" target="_blank" href="${a.snapshot_url}">Open Image</a>
          </div>`;
        div.appendChild(c);
      });
    } catch (e) {
      console.error(e);
      div.innerHTML = "⚠️ Could not load alerts.";
    }
  }

  // ===== Login Check =====
  async function checkSession() {
    const { data } = await supabaseClient.auth.getSession();
    if (data.session) {
      login.style.display = "none";
      alerts.style.display = "block";
      loadAlerts();
      startAutoRefresh();
    } else {
      login.style.display = "block";
      alerts.style.display = "none";
    }
  }

  // ===== Login Handler =====
  loginBtn.onclick = async () => {
    const { error } = await supabaseClient.auth.signInWithPassword({
      email: loginEmail.value,
      password: loginPassword.value
    });
    if (error) {
      loginMsg.textContent = "❌ Login failed";
      return;
    }
    loginMsg.textContent = "✅ Logged in!";
    checkSession();
  };

  // ===== Navigation =====
  homeBtn.onclick = () => {
    home.style.display = "block";
    login.style.display = "none";
    alerts.style.display = "none";
    stopAutoRefresh();
  };

  alertsBtn.onclick = () => {
    home.style.display = "none";
    checkSession();
  };

  // ===== Auto Refresh =====
  let refreshInterval = null;
  function startAutoRefresh() { stopAutoRefresh(); refreshInterval = setInterval(loadAlerts, 30000); }
  function stopAutoRefresh() { if (refreshInterval) clearInterval(refreshInterval); }

  // ===== Init =====
  checkSession();

});
</script>
