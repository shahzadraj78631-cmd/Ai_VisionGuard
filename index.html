<script>
  // ========= Supabase setup =========
  const supabaseUrl = "https://gwlvjpykmjxltiarrvyv.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3bHZqcHlrbWp4bHRpYXJydnl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MTQ2NTEsImV4cCI6MjA3NjE5MDY1MX0.0awguN5ZMtDY4J-aQJOo1sfwE04cql0QMPRWmLe9jiI";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  // ========= DOM references =========
  const homeBtn = document.getElementById("homeBtn");
  const alertsBtn = document.getElementById("alertsBtn");
  const home = document.getElementById("homeSection");
  const alerts = document.getElementById("alertsSection");
  const loginSection = document.getElementById("loginSection");
  const loginBtn = document.getElementById("loginBtn");
  const loginEmail = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");
  const loginMsg = document.getElementById("loginMsg");

  // ========= Load alerts =========
  async function loadAlerts(){
    const { data, error } = await supabaseClient
      .from("alerts")
      .select("*")
      .order("id",{ ascending:false });

    const div = document.getElementById("alertList");
    if(error){ div.innerHTML="Error loading alerts"; return; }
    if(!data || !data.length){ div.innerHTML="No alerts recorded yet."; return; }

    div.innerHTML="";
    data.forEach(a=>{
      const c=document.createElement("div");
      c.className="alert-card row";
      c.innerHTML=`
        <img class="thumb" src="${a.snapshot_url}" alt="snapshot"/>
        <div>
          <b>Type:</b> ${a.type}<br/>
          <b>Person:</b> ${a.person}<br/>
          <a class="contrast" target="_blank" href="${a.snapshot_url}">Open Image</a>
        </div>`;
      div.appendChild(c);
    });
  }

  // ========= Login logic =========
  let userSession = null;

  async function checkSession(){
    const { data } = await supabaseClient.auth.getSession();
    userSession = data.session;
    if(userSession){
      loginSection.style.display = "none";
      alerts.style.display = "block";
      loadAlerts();
    } else {
      loginSection.style.display = "block";
      alerts.style.display = "none";
    }
  }

  loginBtn.onclick = async () => {
    const { data, error } = await supabaseClient.auth.signInWithPassword({
      email: loginEmail.value,
      password: loginPassword.value
    });
    if(error){
      loginMsg.textContent = "❌ Login failed. Check email/password.";
    } else {
      loginMsg.textContent = "✅ Logged in successfully!";
      await checkSession();
    }
  };

  // ========= Toggle buttons =========
  homeBtn.onclick = () => {
    home.style.display="block";
    loginSection.style.display="none";
    alerts.style.display="none";
  };

  alertsBtn.onclick = async () => {
    home.style.display="none";
    await checkSession();
  };

  // ========= Auto refresh =========
  let refreshInterval = null;
  function startAutoRefresh(){
    if(refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(loadAlerts, 30 * 1000);
  }

  // ========= OneSignal setup =========
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(function(OneSignal){
    OneSignal.init({
      appId: "34f002f6-4328-4ab5-bcb2-e24a4f210971",
      notifyButton: { enable: true }
    });
  });

  // ========= Init =========
  checkSession();
</script>
